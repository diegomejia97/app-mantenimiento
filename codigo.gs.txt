function doGet(e) {
  var action = e.parameter.action;
  if (action === "loginUser") {
    return ContentService.createTextOutput(JSON.stringify(loginUser(e.parameter.username, e.parameter.password)))
      .setMimeType(ContentService.MimeType.JSON);
  } else if (action === "buscarCodigo") {
    return ContentService.createTextOutput(JSON.stringify(buscarCodigo(e.parameter.codigo)))
      .setMimeType(ContentService.MimeType.JSON);
  } else if (action === "buscarMantenimientos") {
    return ContentService.createTextOutput(JSON.stringify(buscarMantenimientos(e.parameter.codigo)))
      .setMimeType(ContentService.MimeType.JSON);
  }
  return ContentService.createTextOutput(JSON.stringify({ error: "Acción no válida" }))
    .setMimeType(ContentService.MimeType.JSON);
}

function loginUser(username, password) {
  var sheet = SpreadsheetApp.openById('1C_USJrOi8p51pn0a1gkJvQL-ATJb5zEHldrALdhtRQI').getSheetByName('Usuarios');
  var data = sheet.getDataRange().getValues();
  
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] == username && data[i][1] == password) {
      return { success: true, role: data[i][3], name: data[i][2] };
    }
  }
  return { success: false, error: "Credenciales incorrectas" };
}

function buscarCodigo(codigo) {
  var ss = SpreadsheetApp.openById('1C_USJrOi8p51pn0a1gkJvQL-ATJb5zEHldrALdhtRQI');
  var sheetEquipos = ss.getSheetByName('Equipos');
  var sheetTableros = ss.getSheetByName('Tableros');
  
  var dataEquipos = sheetEquipos.getDataRange().getValues();
  var dataTableros = sheetTableros.getDataRange().getValues();
  
  for (var i = 1; i < dataEquipos.length; i++) {
    if (dataEquipos[i][0] == codigo) {
      var codigoTablero = dataEquipos[i][4]; 
      var tableroImagen = obtenerImagenTablero(dataTableros, codigoTablero);
      return {
        tipo: "Equipo",
        codigo: dataEquipos[i][0],
        nombre: dataEquipos[i][1] || "No disponible",
        ubicacion: dataEquipos[i][2] || "No disponible",
        area: dataEquipos[i][3] || "No disponible",
        tablero: codigoTablero || "No asignado",
        imagen: dataEquipos[i][8] || "",
        estado: dataEquipos[i][5] || "Desconocido",
        mantenimiento: dataEquipos[i][9] || "Sin datos",
        tableroImagen: tableroImagen || ""
      };
    }
  }
  return { error: "Código no encontrado" };
}

function obtenerImagenTablero(dataTableros, codigoTablero) {
  for (var k = 1; k < dataTableros.length; k++) {
    if (dataTableros[k][0] == codigoTablero) {
      return dataTableros[k][7] || "";
    }
  }
  return "";
}

function buscarMantenimientos(codigo) {
  var ss = SpreadsheetApp.openById('1C_USJrOi8p51pn0a1gkJvQL-ATJb5zEHldrALdhtRQI');
  var sheet = ss.getSheetByName('Mantenimientos');
  var data = sheet.getDataRange().getValues();
  var mantenimientos = [];

  for (var i = 1; i < data.length; i++) {
    if (data[i][0] == codigo) {
      mantenimientos.push({
        fecha: data[i][1],
        descripcion: data[i][2],
        tecnico: data[i][3],
        tipo: data[i][4],
        duracion: data[i][5],
        costo: data[i][6],
        observaciones: data[i][7]
      });
    }
  }
  
  return mantenimientos.length > 0 ? { success: true, mantenimientos: mantenimientos } : { success: false, error: "No se encontraron mantenimientos." };
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Identificación de Equipos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Tus estilos CSS aquí */
    </style>
    <script>
        const scriptUrl = "https://script.google.com/macros/s/AKfycbwNJrIagd5Z-tGjSg5lJm6EpkBipWeQDDyWunmdJ3hJw8jlZ83ssjyEdShpHM0dM7m5lw/exec"; // Reemplaza con la URL de despliegue de tu Google Apps Script

        async function login() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const loginButton = document.getElementById("login-button");
            const spinner = document.getElementById("login-spinner");

            if (!username || !password) {
                alert("Por favor, complete todos los campos.");
                return;
            }

            loginButton.disabled = true;
            spinner.style.display = "inline-block";

            const response = await fetch(scriptUrl, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `action=login&username=${username}&password=${password}`
            });
            const data = await response.json();

            if (data.success) {
                document.getElementById("login-section").style.display = "none";
                document.getElementById("search-section").style.display = "block";
                document.getElementById("welcome").innerText = "Bienvenido, " + data.name;
            } else {
                alert("Credenciales incorrectas");
                loginButton.disabled = false;
                spinner.style.display = "none";
            }
        }

        async function buscarCodigo() {
            const codigo = document.getElementById("codigo").value;
            document.getElementById("resultado").innerHTML = "<div class='text-center'><div class='spinner-border text-primary' role='status'></div><p>Cargando...</p></div>";

            const response = await fetch(scriptUrl, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `action=buscarCodigo&codigo=${codigo}`
            });
            const data = await response.json();

            if (data.error) {
                alert(data.error);
                return;
            }

            let imagenesHTML = "";
            if (data.imagen) {
                imagenesHTML += `<div class='col-md-6'><h5>Imagen del equipo</h5><img src="${data.imagen}" class="img-fluid rounded shadow"></div>`;
            }
            if (data.tableroImagen) {
                imagenesHTML += `<div class='col-md-6'><h5>Imagen del tablero</h5><img src="${data.tableroImagen}" class="img-fluid rounded shadow"></div>`;
            }

            let mantenimientoButton = `<button class="btn btn-primary mt-3" onclick="verMantenimientos('${data.codigo}')">Ver Mantenimientos Asociados</button>`;

            document.getElementById("resultado").innerHTML = `
                <div class="card p-4 shadow-lg">
                    <h3 class="text-primary">${data.tipo}: ${data.codigo}</h3>
                    <p><b>Nombre:</b> ${data.nombre}</p>
                    <p><b>Ubicación:</b> ${data.ubicacion}</p>
                    <p><b>Área:</b> ${data.area}</p>
                    <p><b>Estado:</b> ${data.estado}</p>
                    <p><b>Mantenimiento:</b> ${data.mantenimiento}</p>
                    ${data.tipo === "Equipo" ? `<p><b>Tablero:</b> ${data.tablero}</p>` : `<p><b>Equipos:</b> ${data.equipos}</p>`}
                    <div class="row">${imagenesHTML}</div>
                    <div class="text-center">${mantenimientoButton}</div>
                </div>
            `;
        }

        async function verMantenimientos(codigo) {
            document.getElementById("mantenimiento-list").innerHTML = "<div class='text-center'><div class='spinner-border text-primary' role='status'></div><p>Cargando...</p></div>";
            const modal = new bootstrap.Modal(document.getElementById('modalMantenimientos'));
            modal.show();

            const response = await fetch(scriptUrl, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `action=buscarMantenimientos&codigo=${codigo}`
            });
            const data = await response.json();

            if (data.success) {
                let contenido = `<table class="table table-hover table-bordered text-center"><thead class="table-dark"><tr><th>Fecha</th><th>Descripción</th><th>Técnico</th><th>Tipo</th><th>Duración</th><th>Costo</th><th>Estado</th><th>Observaciones</th></tr></thead><tbody>`;
                data.mantenimientos.forEach(m => {
                    contenido += `<tr><td>${m.fecha}</td><td>${m.descripcion}</td><td>${m.tecnico}</td><td>${m.tipo}</td><td>${m.duracion}</td><td>${m.costo}</td><td>${m.estado}</td><td>${m.observaciones}</td></tr>`;
                });
                contenido += "</tbody></table>";
                document.getElementById("mantenimiento-list").innerHTML = contenido;
            } else {
                alert(data.error);
            }
        }

        function logout() {
            document.getElementById("login-section").style.display = "block";
            document.getElementById("search-section").style.display = "none";
            document.getElementById("username").value = "";
            document.getElementById("password").value = "";
            document.getElementById("login-button").disabled = false;
            document.getElementById("login-spinner").style.display = "none";
        }
    </script>
</head>
 <body class="container py-4">
      <div id="login-section" class="login-container text-center">
          <h2>Sistema de Identificación de Equipos - Pinturas ENAR</h2>
          <input type="text" id="username" class="form-control mb-2" placeholder="Usuario">
          <input type="password" id="password" class="form-control mb-2" placeholder="Contraseña">
          <button id="login-button" class="btn btn-success" onclick="login()">Ingresar</button>
          <div id="login-spinner" class="spinner-border text-success ms-2" role="status"></div>
      </div>
    
    <div id="search-section" class="search-container text-center hidden">
        <h2 id="welcome"></h2>
        <div class="input-group mb-3">
            <input type="text" id="codigo" class="form-control" placeholder="Ingrese código">
            <button class="btn btn-primary" onclick="buscarCodigo()">Buscar</button>
        </div>
        <div id="resultado" class="mt-3"></div>
        <button class="btn btn-danger mt-3" onclick="logout()">Cerrar Sesión</button>
    </div>

<footer class="footer">
    <div class="footer-content">
        <p>Desarrollado por <strong>IDEA SAS</strong> | 📍 Funza, Cundinamarca</p>
    </div>
</footer>

<div class="modal fade" id="modalMantenimientos" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-fullscreen-sm-down">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mantenimientos Asociados</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body" style="overflow-y: auto; max-height: 80vh;">
                <div id="mantenimiento-list" class="table-responsive"></div>
            </div>
        </div>
    </div>
</div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
